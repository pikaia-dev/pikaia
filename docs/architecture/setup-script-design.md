# Setup Script Design: `npx pikaia-setup`

A minimal-conflict setup experience that preserves upstream merge compatibility.

---

## Design Philosophy

**Core Principle:** Generate config files, don't modify source code.

| Goal | Approach |
|------|----------|
| Pull upstream changes | No source code modifications |
| Customize branding | Environment variables |
| Customize AWS resources | CDK context |
| Generate secrets | Write to `.env` files |
| Merge conflicts | Limited to 4 files (package names only) |

---

## Prerequisites: Codebase Refactoring

Before the setup script can work, the codebase needs these changes:

### Phase 1: Environment Variables (Backend)

**File: `backend/config/settings/base.py`**

```python
# Current (hardcoded):
WEBAUTHN_RP_NAME: str = "Pikaia"
DEVICE_LINK_URL_SCHEME = "pikaia://device/link"

# After (configurable):
WEBAUTHN_RP_NAME: str = env("WEBAUTHN_RP_NAME", default="Pikaia")
DEVICE_LINK_URL_SCHEME: str = env("DEVICE_LINK_URL_SCHEME", default="pikaia://device/link")
```

**File: `backend/apps/billing/management/commands/setup_stripe.py`**

```python
# Current (hardcoded):
metadata={"app": "pikaia"}

# After (configurable):
from django.conf import settings
metadata={"app": settings.APP_SLUG}

# In settings:
APP_SLUG: str = env("APP_SLUG", default="pikaia")
```

### Phase 2: CDK Context Parameters

**File: `infra/cdk.json`** — Add defaults:

```json
{
  "app": "python app.py",
  "context": {
    "resource_prefix": "pikaia",
    "ecr_repository_name": "pikaia-backend",
    "secrets_path": "pikaia/app-secrets",
    "database_name": "pikaia",
    "event_bus_name": "pikaia-events",
    "alarm_topic_name": "pikaia-alarms",
    "dashboard_name": "pikaia-operations",
    "frontend_bucket_prefix": "pikaia-frontend",
    "log_stream_prefix": "pikaia-backend"
  }
}
```

**File: `infra/stacks/app_stack.py`** — Read from context:

```python
# Current (hardcoded):
repository_name="pikaia-backend"
secret_name="pikaia/app-secrets"
default_database_name="pikaia"

# After (from context):
resource_prefix = self.node.try_get_context("resource_prefix") or "pikaia"
repository_name = self.node.try_get_context("ecr_repository_name") or f"{resource_prefix}-backend"
secret_name = self.node.try_get_context("secrets_path") or f"{resource_prefix}/app-secrets"
database_name = self.node.try_get_context("database_name") or resource_prefix
```

**Similar changes needed in:**
- `infra/stacks/events_stack.py` — Lambda names, SQS queues, EventBridge
- `infra/stacks/observability_stack.py` — Dashboard, SNS topic, alarm names
- `infra/stacks/frontend_stack.py` — S3 bucket prefix

### Phase 3: Docker Compose (Local Dev)

**File: `docker-compose.yml`** — Use environment substitution:

```yaml
name: ${COMPOSE_PROJECT_NAME:-pikaia}

services:
  postgres:
    container_name: ${COMPOSE_PROJECT_NAME:-pikaia}-postgres
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-pikaia}
```

### Phase 4: Bootstrap Scripts

**File: `scripts/bootstrap-infra.sh`**

```bash
# Current (hardcoded):
ECR_REPO_NAME="pikaia-backend"
SECRETS_NAME="pikaia/app-secrets"

# After (from env or argument):
RESOURCE_PREFIX="${RESOURCE_PREFIX:-pikaia}"
ECR_REPO_NAME="${ECR_REPO_NAME:-${RESOURCE_PREFIX}-backend}"
SECRETS_NAME="${SECRETS_NAME:-${RESOURCE_PREFIX}/app-secrets}"
```

---

## What the Setup Script Does

After the refactoring above, the setup script becomes simple:

### Input: User Prompts

```
◆ Project Configuration

◇ Display name (shown to users)
│  Acme Platform

◇ Resource prefix (lowercase, for AWS resources)
│  acme

◇ Production domain
│  app.acme.com
```

### Output: Generated Files

**1. `backend/.env`** (local development)
```env
# Generated by pikaia-setup
APP_SLUG=acme
WEBAUTHN_RP_NAME=Acme Platform
DEVICE_LINK_URL_SCHEME=acme://device/link

# Generated secrets
SECRET_KEY=<generated>
FIELD_ENCRYPTION_KEY=<generated>

# Third-party (prompted or skipped)
STYTCH_PROJECT_ID=
STYTCH_SECRET=
STRIPE_SECRET_KEY=
```

**2. `frontend/.env`** (local development)
```env
VITE_API_URL=http://localhost:8000/api/v1
VITE_STYTCH_PUBLIC_TOKEN=
```

**3. `.env.production`** (for AWS secrets bootstrap)
```env
APP_SLUG=acme
WEBAUTHN_RP_NAME=Acme Platform
WEBAUTHN_RP_ID=app.acme.com
WEBAUTHN_ORIGIN=https://app.acme.com
CORS_ALLOWED_ORIGINS=https://app.acme.com

# Secrets (prompted)
DJANGO_SECRET_KEY=<generated>
STYTCH_PROJECT_ID=<prompted>
# ... etc
```

**4. `infra/cdk.context.json`** (CDK deploy-time config)
```json
{
  "resource_prefix": "acme",
  "ecr_repository_name": "acme-backend",
  "secrets_path": "acme/app-secrets",
  "database_name": "acme",
  "event_bus_name": "acme-events",
  "alarm_topic_name": "acme-alarms",
  "dashboard_name": "acme-operations",
  "frontend_bucket_prefix": "acme-frontend",
  "log_stream_prefix": "acme-backend",

  "domain_name": "api.acme.com",
  "frontend_domain": "app.acme.com",
  "certificate_arn": "<prompted>"
}
```

**5. `.env.local`** (Docker Compose override)
```env
COMPOSE_PROJECT_NAME=acme
POSTGRES_DB=acme
```

---

## Merge Conflict Analysis

### Files That NEVER Conflict (config-driven)

| File Type | Reason |
|-----------|--------|
| All Python source | Reads from env vars |
| All CDK stacks | Reads from context |
| All TypeScript | No branding hardcoded |
| Docker Compose | Uses env substitution |
| Bootstrap scripts | Uses env vars |

### Files That MAY Conflict (manual change, one-time)

| File | Field | Conflict Likelihood |
|------|-------|---------------------|
| `package.json` | `"name": "pikaia"` | Low (rarely changes upstream) |
| `backend/pyproject.toml` | `name = "pikaia-backend"` | Low |
| `infra/pyproject.toml` | `name = "pikaia-infra"` | Low |
| `infra/functions/image-transform/package.json` | `"name": "@pikaia/..."` | Very low |

**Recommendation:** Don't auto-rename these. Document as optional manual change. Users who want clean branding can change them once; users who want easy merges can leave them as "pikaia".

### Files in `.gitignore` (never conflict)

```
.env
.env.local
.env.production
infra/cdk.context.json
```

These generated files should be gitignored so they never cause conflicts.

---

## Setup Script Architecture

### Simple Bash + Node Hybrid

```
scripts/
└── setup/
    ├── setup.sh              # Entry point (checks Node, runs JS)
    ├── package.json          # Minimal deps
    └── src/
        ├── index.ts          # Main flow
        ├── prompts.ts        # User prompts (clack)
        ├── generators/
        │   ├── env.ts        # .env file generation
        │   ├── cdk-context.ts
        │   └── secrets.ts    # Crypto generation
        └── validators/
            ├── stytch.ts     # API key validation
            ├── stripe.ts
            └── aws.ts
```

### Dependencies (Minimal)

```json
{
  "dependencies": {
    "@clack/prompts": "^0.7.0",
    "picocolors": "^1.0.0"
  }
}
```

No build step needed — run directly with `npx tsx`.

---

## User Experience

### First Run

```
$ ./scripts/setup/setup.sh

  ╭─────────────────────────────────────╮
  │  Pikaia Setup                       │
  │  B2B SaaS Starter                   │
  ╰─────────────────────────────────────╯

  ◆ What would you like to configure?
  │  ◼ Project branding (name, prefix)
  │  ◼ Local development environment
  │  ◻ Third-party services (Stytch, Stripe, Resend)
  │  ◻ AWS deployment
  └

  ◇ Display name (shown to users in UI, emails, passkey prompts)
  │  Acme Platform

  ◇ Resource prefix (lowercase, used for AWS resources, database)
  │  acme

  ● Generating configuration...
    ✓ backend/.env
    ✓ frontend/.env
    ✓ .env.local (Docker Compose)

  ✓ Setup complete!

  Next steps:
    1. Start local dev:  docker compose up -d && cd backend && uv run manage.py runserver
    2. Configure services:  ./scripts/setup/setup.sh (select "Third-party services")
    3. Read the docs:  docs/guides/local-development.md
```

### Subsequent Runs (Idempotent)

```
$ ./scripts/setup/setup.sh

  ℹ Existing configuration detected

  ◆ What would you like to do?
  │  ○ View current configuration
  │  ○ Update project branding
  │  ○ Configure third-party services
  │  ○ Prepare AWS deployment
  │  ○ Regenerate secrets
  └
```

### CI Mode

```bash
# Non-interactive for CI/automation
./scripts/setup/setup.sh --ci \
  --name "Acme Platform" \
  --prefix "acme" \
  --domain "app.acme.com"
```

---

## State Tracking

### `.pikaia-setup.json`

Minimal state to enable idempotency:

```json
{
  "version": "1.0.0",
  "configured_at": "2026-01-29T12:00:00Z",
  "project": {
    "display_name": "Acme Platform",
    "prefix": "acme"
  },
  "services": {
    "stytch": { "configured": true, "environment": "test" },
    "stripe": { "configured": false },
    "resend": { "configured": false }
  },
  "aws": {
    "configured": false
  }
}
```

---

## Commands

```bash
# Interactive setup (recommended)
./scripts/setup/setup.sh

# Specific operations
./scripts/setup/setup.sh branding      # Just project name/prefix
./scripts/setup/setup.sh services      # Third-party API keys
./scripts/setup/setup.sh aws           # AWS deployment prep
./scripts/setup/setup.sh secrets       # Regenerate secrets
./scripts/setup/setup.sh status        # Show current config
./scripts/setup/setup.sh doctor        # Check for issues

# Flags
--ci                    # Non-interactive mode
--name "App Name"       # Display name
--prefix "app"          # Resource prefix
--domain "app.com"      # Production domain
--yes                   # Accept defaults
```

---

## Implementation Checklist

### Codebase Refactoring (Do First)

- [x] `backend/config/settings/base.py` — Add `APP_SLUG`, `DEVICE_LINK_URL_SCHEME` as env vars
- [x] `backend/apps/billing/management/commands/setup_stripe.py` — Use `settings.APP_SLUG`
- [x] `infra/cdk.json` — Add context defaults
- [x] `infra/stacks/app_stack.py` — Read resource names from context
- [x] `infra/stacks/events_stack.py` — Read resource names from context
- [x] `infra/stacks/observability_stack.py` — Read resource names from context
- [x] `infra/stacks/frontend_stack.py` — Read bucket prefix from context
- [x] `docker-compose.yml` — Add env var substitution
- [x] `scripts/bootstrap-infra.sh` — Read from env vars
- [x] `scripts/bootstrap-secrets.sh` — Read from env vars
- [x] `.gitignore` — Add `cdk.context.json`, `.pikaia-setup.json`
- [x] `.env.example` files — Add new env vars with defaults

### Setup Script (After Refactoring)

- [x] `scripts/setup/package.json` — Minimal dependencies (`@clack/prompts`, `picocolors`, `tsx`)
- [x] `scripts/setup/src/index.ts` — Main entry point with CLI parsing and commands
- [x] `scripts/setup/src/prompts.ts` — Clack prompts (branding, services, AWS)
- [x] `scripts/setup/src/generators/env.ts` — .env generation (backend, frontend, docker, production)
- [x] `scripts/setup/src/generators/cdk-context.ts` — CDK context generation
- [x] `scripts/setup/src/generators/secrets.ts` — Crypto key generation
- [x] `scripts/setup/src/validators.ts` — Input validation (prefix, domain, API key format)
- [x] `scripts/setup/src/state.ts` — State tracking (`.pikaia-setup.json`)
- [x] `scripts/setup/setup.sh` — Bash entry point

### Documentation

- [x] Update `docs/guides/local-development.md` — Reference setup script
- [x] Update `README.md` — Add setup instructions
- [ ] Create `docs/guides/forking.md` — Guide for forking and customizing
- [x] Update `CONTRIBUTING.md` — Note about env var conventions

---

## Pulling Upstream Changes

After setup, users can pull upstream changes:

```bash
# Add upstream remote (one-time)
git remote add upstream https://github.com/pikaia-dev/pikaia.git

# Pull changes
git fetch upstream
git merge upstream/main

# Expected conflicts: NONE (all config is in gitignored files)
# Possible conflicts: package.json name field (if manually changed)
```

### If Package Names Were Changed

```bash
# After merge, if there are conflicts in package.json:
git checkout --theirs package.json  # Keep upstream version
# OR
git checkout --ours package.json    # Keep your renamed version
```

---

## Summary

| Before | After |
|--------|-------|
| Find-replace 50+ files | Generate 5 config files |
| Merge conflicts everywhere | Merge conflicts in 0-4 files |
| Complex setup script | Simple config generator |
| Fragile pattern matching | Robust env var/context lookup |
| Can't pull upstream | Easy upstream merges |
